###########################################
########### Run GUI Logic tests ###########
###########################################

.gui_logic_test:
  image: nganalytics/nga:gui-test
  stage: gui-test
  needs: []
  before_script: # Load python virtualenv and workaround vtk no X server bug
    - echo "==================== [GUI Logic ${GUI_TEST_NAME}] Activate virtualenv ===================="
    - virtualenv venv
    - source venv/bin/activate
    - export PYTHONPATH=$(pwd)/venv/lib/python3.8/site-packages
    - echo $PYTHONPATH
    - pip install -r requirements.txt
    - echo "==================== [GUI Logic ${GUI_TEST_NAME}] Check Python dependencies ===================="
    - python --version
    - python .gitlab/ci/TestImport.py
    - export DISPLAY=:99.0
    - Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &

# GUI Logic integration tests
GUI integration tests:
  variables:
    GUI_TEST_NAME: "integration"
  extends:
    - .gui_logic_test
    - .with_python_cache
  script:
    - echo "==================== [GUI Logic ${GUI_TEST_NAME}] Run GUI tests ===================="
    - python -m tests.GUI_tests.integrationtests.integration
  artifacts:
    expire_in: 1 week
    expose_as: "GUI integration tests reports"
    paths:
      - tests/GUI_tests/integrationtests/GUI_integrationtests/
  rules:
    - if: '$CI_COMMIT_REF_PROTECTED == "true"'
      changes:
        - arg/GUI/Logic/*
        - tests/GUI_tests/**/*
        - arg/Aggregation/*
        - arg/Applications/*
        - arg/Backend/*
        - arg/Common/*
        - arg/DataInterface/*
        - arg/Generation/*
        - arg/Tools/*
        - arg/__init__.py
        - arg/__version__.py
        - requirements.txt
    - if: '$CI_COMMIT_REF_PROTECTED == "" || $CI_COMMIT_REF_PROTECTED == "false"'
      changes:
        - arg/GUI/Logic/*
        - tests/GUI_tests/**/*
        - arg/Aggregation/*
        - arg/Applications/*
        - arg/Backend/*
        - arg/Common/*
        - arg/DataInterface/*
        - arg/Generation/*
        - arg/Tools/*
        - arg/__init__.py
        - arg/__version__.py
        - requirements.txt

# GUI Logic unit tests
GUI unit tests:
  variables:
    GUI_TEST_NAME: "unit"
  extends:
    - .gui_logic_test
    - .with_python_cache
  script:
    - echo "==================== [GUI Logic ${GUI_TEST_NAME}] Run GUI tests ===================="
    - pip install coverage
    - coverage run --source arg/GUI -m unittest discover -s "tests/GUI_tests" -p "test_*.py"
    - coverage report -m
    - coverage html -d coverage_html
  artifacts:
    expire_in: 1 week
    expose_as: "GUI unit tests coverage"
    paths:
      - coverage_html/
  coverage: '/^TOTAL.*\s+(\d+\%)$/'
  rules:
    - if: '$CI_COMMIT_REF_PROTECTED == "true"'
      changes:
        - arg/GUI/Logic/*
        - tests/GUI_tests/**/*
        - arg/Aggregation/*
        - arg/Applications/*
        - arg/Backend/*
        - arg/Common/*
        - arg/DataInterface/*
        - arg/Generation/*
        - arg/Tools/*
        - arg/__init__.py
        - arg/__version__.py
        - requirements.txt
    - if: '$CI_COMMIT_REF_PROTECTED == "" || $CI_COMMIT_REF_PROTECTED == "false"'
      changes:
        - arg/GUI/Logic/*
        - tests/GUI_tests/**/*
        - arg/Aggregation/*
        - arg/Applications/*
        - arg/Backend/*
        - arg/Common/*
        - arg/DataInterface/*
        - arg/Generation/*
        - arg/Tools/*
        - arg/__init__.py
        - arg/__version__.py
        - requirements.txt

# GUI Logic Flask server tests
GUI flask tests:
  variables:
    GUI_TEST_NAME: "Flask"
  extends:
    - .gui_logic_test
    - .with_python_cache
  script:
    - echo "==================== [GUI Logic ${GUI_TEST_NAME}] Run GUI tests ===================="
    - pip install coverage
    - coverage run --source arg/GUI -m unittest discover -s "tests/web_api_tests" -p "test_*.py"
    - coverage report -m
    - coverage html -d coverage_html
  artifacts:
    expire_in: 1 week
    expose_as: "GUI flask tests coverage"
    paths:
      - coverage_html/
  coverage: '/^TOTAL.*\s+(\d+\%)$/'
  rules:
    - if: '$CI_COMMIT_REF_PROTECTED == "true"'
      changes:
        - web/api/**/*
        - tests/web_api_tests/*
        - arg/Aggregation/*
        - arg/Applications/*
        - arg/Backend/*
        - arg/Common/*
        - arg/DataInterface/*
        - arg/Generation/*
        - arg/Tools/*
        - arg/__init__.py
        - arg/__version__.py
        - requirements.txt
    - if: '$CI_COMMIT_REF_PROTECTED == "" || $CI_COMMIT_REF_PROTECTED == "false"'
      changes:
        - web/api/**/*
        - tests/web_api_tests/*
        - arg/Aggregation/*
        - arg/Applications/*
        - arg/Backend/*
        - arg/Common/*
        - arg/DataInterface/*
        - arg/Generation/*
        - arg/Tools/*
        - arg/__init__.py
        - arg/__version__.py
        - requirements.txt

##########################################
########### Run GUI View tests ###########
##########################################

.gui_view_test:
  image: nganalytics/nga:gui-test
  stage: gui-test
  needs: []
  before_script:
    - echo "==================== [${GUI_TEST_NAME} GUI View] Run GUI tests ===================="

# Qt GUI tests on View component
Qt GUI tests:
  variables:
    GUI_TEST_NAME: "Qt"
  extends:
    - .gui_view_test
    - .with_python_cache
  script:
    - echo "==================== [${GUI_TEST_NAME} GUI View] Run GUI tests ===================="
    - echo "TODO"
  rules:
    - if: '$CI_COMMIT_REF_PROTECTED == "true"'
      changes:
        - arg/GUI/View/*
        - arg/Aggregation/*
        - arg/Applications/*
        - arg/Backend/*
        - arg/Common/*
        - arg/DataInterface/*
        - arg/Generation/*
        - arg/Tools/*
        - arg/__init__.py
        - arg/__version__.py
        - requirements.txt
    - if: '$CI_COMMIT_REF_PROTECTED == "" || $CI_COMMIT_REF_PROTECTED == "false"'
      changes:
        - arg/GUI/View/*
        - arg/Aggregation/*
        - arg/Applications/*
        - arg/Backend/*
        - arg/Common/*
        - arg/DataInterface/*
        - arg/Generation/*
        - arg/Tools/*
        - arg/__init__.py
        - arg/__version__.py
        - requirements.txt

# plug-in GUI tests on View component
plug-in GUI tests:
  variables:
    GUI_TEST_NAME: "plug-in"
  extends:
    - .gui_view_test
    - .with_python_cache
  script:
    - echo "==================== [${GUI_TEST_NAME} GUI View] Run GUI tests ===================="
    - echo "TODO"
  rules:
    - if: '$CI_COMMIT_REF_PROTECTED == "true"'
      changes:
        - web/angular/**/*
    - if: '$CI_COMMIT_REF_PROTECTED == "" || $CI_COMMIT_REF_PROTECTED == "false"'
      changes:
        - web/angular/**/*