###########################
#### Package Web stage ####
###########################


#Build angular client
Build Angular app / Deploy to Flask server:
  stage: check-package
  needs: []
  image: trion/ng-cli
  script:
    - echo "==================== [pypi Package] Install Angular dependencies ===================="
    - cd web/angular
    - npm install
    - echo "==================== [pypi Package] Build Angular client ===================="
    - ng build --prod --base-href /static/
    - echo "==================== [pypi Package] Deploy to Flask server ===================="
    - cd ../../web/api
    - mkdir static
    - mkdir templates
    - mv ../angular/dist/ARG-GUI-angular/index.html templates/index.html
    - cp -R ../angular/dist/ARG-GUI-angular/* static/
  artifacts:
    expire_in: 3 days
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME"
    paths:
      - web/api
  rules:
#   Always run when pushing a release candidate
    - if: $CI_COMMIT_REF_NAME =~ /^\d{1,}\.\d{1,}\.\d{1,}-RC\d{1,}/
    - if: '$CI_COMMIT_REF_PROTECTED == "true"'
    - if: '$CI_COMMIT_REF_PROTECTED == "" || $CI_COMMIT_REF_PROTECTED == "false"'
      changes:
      - web/**/*