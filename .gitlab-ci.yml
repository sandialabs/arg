#####################################
########## Global Settings ##########
#####################################

# Optimizing Docker image loading
# https://docs.gitlab.com/ce/ci/docker/using_docker_build.html#using-the-overlayfs-driver
variables:
  DOCKER_DRIVER: overlay2
  DEFAULT_OS: "Debian"
  DEPLOYMENT_PYPI_SRC: ".gitlab/deployment/pypi"

# Stages definition
stages:
  - build-pypi
  - deploy

###########################
####### Build stage #######
###########################

#Build arg on pypi
Build pyARG:
  image: python:3.7-slim
  stage: build-pypi
  variables:
    PACKAGING_PATH: "package"
  before_script:
    - echo "========== Getting Packaging dependencies ==========="
    - pip install --upgrade pip
    - pip install wheel
    - pip install twine
  script:
    - echo "==================== Build pyARG ===================="
    - mkdir $PACKAGING_PATH/
    - cp $DEPLOYMENT_PYPI_SRC/* $PACKAGING_PATH/
    - cp LICENSE $PACKAGING_PATH/
    - cp README.md $PACKAGING_PATH/
    - cp -R arg/ $PACKAGING_PATH/arg/
    - ls -al $PACKAGING_PATH/
    - cd $PACKAGING_PATH
    - python setup.py sdist bdist_wheel
    - twine check dist/*
  artifacts:
    expire_in: 7 days
    expose_as: "pyARG wheel package"
    name: "pyARG"
    paths:
      - $PACKAGING_PATH/
      - $PACKAGING_PATH/dist/

###########################
###### Deploy stage #######
###########################

#Deploy pyARG on pypi
Upload in Gitlab.com:
  image: python:3.7-slim
  stage: deploy
  needs:
    - job: "Build pyARG"
      artifacts: True
  variables:
    PACKAGING_PATH: "package"
  before_script:
    - echo "========== Getting Uploading dependencies ==========="
    - pip install --upgrade pip
    - pip install twine
  script:
    - echo "==================== Upload pyARG ==================="
    - twine upload --repository-url https://gitlab.com/api/v4/projects/18732201/packages/pypi --username $GITLAB_PYPI_USER --password $GITLAB_PYPI_PASS $PACKAGING_PATH/dist/*
    # Try to install pyARG from gitlab packages
    #- pip install --index-url https://gitlab.com/api/v4/projects/18732201/packages/ pyARG==1.0.0
    #- python -c "import arg"
    #- pip uninstall pyARG -y

#Deploy pyARG on pypi
Upload in test.pypi.org:
  image: python:3.7-slim
  stage: deploy
  needs:
    - job: "Build pyARG"
      artifacts: True
  variables:
    PACKAGING_PATH: "package"
  before_script:
    - echo "========== Getting Uploading dependencies ==========="
    - pip install --upgrade pip
    - pip install twine
  script:
    - echo "========== Upload pyARG on test.pypi.org ============"
    - twine upload --repository-url https://test.pypi.org/legacy/ --username $PYPI_TEST_USER --password $PYPI_TEST_PASS $PACKAGING_PATH/dist/*
    - pip install --index-url https://test.pypi.org/simple/ pyARG
    - python -c "import arg"
    - pip uninstall pyARG -y
  when: manual

#Deploy pyARG on pypi
Upload in pypi.org:
  image: python:3.7-slim
  stage: deploy
  needs:
    - job: "Build pyARG"
      artifacts: True
  variables:
    PACKAGING_PATH: "package"
  before_script:
    - echo "========== Getting Uploading dependencies ==========="
    - pip install --upgrade pip
    - pip install --upgrade twine
  script:
    - echo "========= Upload pyARG on pypi.org/legacy ==========="
    - twine upload --repository-url https://upload.pypi.org/legacy/ --username $TWINE_USERNAME --password $TWINE_PASSWORD $PACKAGING_PATH/dist/*
    - pip install pyARG
    - python -c "import arg"
    - pip uninstall pyARG -y
  when: manual
